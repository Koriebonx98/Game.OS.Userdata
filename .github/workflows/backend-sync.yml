# Backend Sync & Health Check
#
# Triggered:
#   â€¢ Automatically when the main branch is updated (push)
#   â€¢ Manually via workflow_dispatch
#
# What it does:
#   1. Verifies the backend source is still in sync with the frontend expectations
#      (checks that required API endpoints exist in backend/index.js).
#   2. Archives an encrypted copy of the current backend config for audit.
#
# Required secrets (Settings â†’ Secrets and variables â†’ Actions):
#   ENCRYPTION_KEY   â€“ AES-256 passphrase for encrypting the config archive.
#
# Note: DATA_REPO_TOKEN is stored ONLY in the backend server's environment variables.
# It is never injected into frontend files or stored in repository secrets.

name: Backend Sync

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'script.js'
  workflow_dispatch:

permissions:
  contents: read
  actions: write   # required for actions/upload-artifact to store artifacts

jobs:
  # â”€â”€ 1. Sync check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sync-check:
    name: Frontend â†” Backend Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Verify backend syntax
        run: node --check backend/index.js && echo "âœ… backend/index.js syntax OK"

      - name: Verify frontend script syntax
        run: node --check script.js && echo "âœ… script.js syntax OK"

      - name: Check required API endpoints are present
        run: |
          python3 << 'PYEOF'
          import sys

          REQUIRED_ENDPOINTS = [
              '/api/verify-account',
              '/api/create-account',
              '/api/check-user',
              '/api/game-library',
              '/api/update-presence',
              '/api/get-presence',
          ]

          with open('backend/index.js', 'r', encoding='utf-8') as f:
              content = f.read()

          missing = [ep for ep in REQUIRED_ENDPOINTS if ep not in content]

          if missing:
              print(f'ðŸš¨ Missing expected API endpoints in backend/index.js:')
              for ep in missing:
                  print(f'   â€¢ {ep}')
              sys.exit(1)
          else:
              print('âœ… All required API endpoints found in backend/index.js')
          PYEOF

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci --ignore-scripts

      - name: Run dependency audit (backend)
        working-directory: backend
        run: npm audit --audit-level=critical || true

      - name: Archive encrypted backend config snapshot
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          # Create a sanitised config snapshot (no secrets)
          python3 << 'PYEOF'
          import json, os

          snapshot = {
              "timestamp": __import__('datetime').datetime.utcnow().isoformat() + 'Z',
              "node_version_required": ">=18",
              "endpoints": ["/api/login", "/api/signup", "/api/user"],
              "repo": os.environ.get('GITHUB_REPOSITORY', ''),
              "sha": os.environ.get('GITHUB_SHA', ''),
          }
          with open('/tmp/backend-config-snapshot.json', 'w') as f:
              json.dump(snapshot, f, indent=2)
          print("Config snapshot created")
          PYEOF

          if [ -n "$ENCRYPTION_KEY" ]; then
            openssl enc -aes-256-cbc -pbkdf2 -pass env:ENCRYPTION_KEY \
              -in  /tmp/backend-config-snapshot.json \
              -out /tmp/backend-config-snapshot.json.enc
            ARTIFACT=/tmp/backend-config-snapshot.json.enc
            echo "Snapshot encrypted with AES-256-CBC"
          else
            ARTIFACT=/tmp/backend-config-snapshot.json
            echo "ENCRYPTION_KEY not set â€“ snapshot stored unencrypted"
          fi
          cp "$ARTIFACT" /tmp/backend-snapshot

      - name: Upload config snapshot artifact
        uses: actions/upload-artifact@v6
        with:
          name: backend-config-snapshot
          path: /tmp/backend-snapshot
          retention-days: 30
