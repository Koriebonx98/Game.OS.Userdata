# Scrape Exophase Achievements
#
# Fetches an Exophase achievements page server-side (no CORS restriction),
# parses the achievement list, writes it to a local JSON file, then checks out
# Games.Database and commits the file via git ‚Äî no Octokit API calls needed.
#
# Can be triggered two ways:
#   1. Manually via the GitHub Actions UI (Actions ‚Üí Scrape Exophase ‚Üí Run workflow)
#      ‚Äî works from any device including a phone.
#   2. Automatically from the Game.OS admin panel "üîÑ Scrape JSON" button.
#
# Required secret (Settings ‚Üí Secrets and variables ‚Üí Actions):
#   GAMES_DB_TOKEN  ‚Äì Fine-grained PAT with Contents: Read and write on
#                     Koriebonx98/Games.Database

name: Scrape Exophase Achievements

on:
  workflow_dispatch:
    inputs:
      exophase_url:
        description: 'Exophase achievements page URL (https://www.exophase.com/game/‚Ä¶/achievements/)'
        required: true
      platform:
        description: 'Platform (PS4, PS3, Switch, Xbox 360, PS5, Xbox One, PC)'
        required: true
        default: 'PS4'
      game_title:
        description: 'Game title (used in the commit message)'
        required: true
      title_id:
        description: 'Title ID ‚Äî folder name inside Data/{platform}/Games/ (alphanumeric, underscores, hyphens only)'
        required: true

permissions:
  contents: read

jobs:
  scrape:
    name: Scrape and Write Achievements
    runs-on: ubuntu-latest

    steps:
      - name: Validate GAMES_DB_TOKEN is configured
        run: |
          if [ -z "$GAMES_DB_TOKEN" ]; then
            echo "‚ùå GAMES_DB_TOKEN is not set."
            echo "   Add it as a repository secret: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo "   The token must be a fine-grained PAT with Contents: Read and write on Koriebonx98/Games.Database."
            exit 1
          fi
          echo "‚úÖ GAMES_DB_TOKEN is configured"
        env:
          GAMES_DB_TOKEN: ${{ secrets.GAMES_DB_TOKEN }}

      - name: Checkout Game.OS.Userdata (for the scrape script)
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci --ignore-scripts

      - name: Scrape Exophase and write local JSON
        run: node backend/scrape-exophase-action.js
        env:
          EXOPHASE_URL: ${{ inputs.exophase_url }}
          PLATFORM: ${{ inputs.platform }}
          GAME_TITLE: ${{ inputs.game_title }}
          TITLE_ID: ${{ inputs.title_id }}
          OUTPUT_FILE: /tmp/achievements.json

      - name: Determine Games.Database platform folder
        id: platform
        run: |
          case "${{ inputs.platform }}" in
            "Switch")   echo "folder=Nintendo - Switch"    >> "$GITHUB_OUTPUT" ;;
            "Xbox 360") echo "folder=Microsoft - Xbox 360" >> "$GITHUB_OUTPUT" ;;
            "PS3")      echo "folder=Sony - PlayStation 3" >> "$GITHUB_OUTPUT" ;;
            "PS4")      echo "folder=Sony - PlayStation 4" >> "$GITHUB_OUTPUT" ;;
            "PS5")      echo "folder=Sony - PlayStation 5" >> "$GITHUB_OUTPUT" ;;
            "Xbox One") echo "folder=Microsoft - Xbox One" >> "$GITHUB_OUTPUT" ;;
            "PC")       echo "folder=PC"                   >> "$GITHUB_OUTPUT" ;;
            *)          echo "‚ùå Unknown platform: ${{ inputs.platform }}. Supported: Switch, Xbox 360, PS3, PS4, PS5, Xbox One, PC"; exit 1 ;;
          esac

      - name: Checkout Games.Database
        uses: actions/checkout@v6
        with:
          repository: Koriebonx98/Games.Database
          token: ${{ secrets.GAMES_DB_TOKEN }}
          path: games-database

      - name: Copy achievements.json into Games.Database
        run: |
          DEST="games-database/Data/${{ steps.platform.outputs.folder }}/Games/${{ inputs.title_id }}/achievements.json"
          mkdir -p "$(dirname "$DEST")"
          cp /tmp/achievements.json "$DEST"
          echo "‚úÖ Copied to $DEST"

      - name: Commit and push to Games.Database
        working-directory: games-database
        run: |
          git config user.name  "Game OS Bot"
          git config user.email "bot@gameos.com"
          git add .
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit ‚Äî achievements.json is already up to date."
          else
            git commit -m "Add achievements for ${{ inputs.game_title }} (${{ inputs.platform }}) from Exophase"
            git push
          fi

