# Seed PC.Games.json in the Games.Database repository
#
# Creates PC.Games.json with an initial set of PC games if the file does not
# already exist.  Run this once after initial deployment to make the PC
# platform browsable in Game.OS.
#
# Required secret:
#   GAMES_DB_TOKEN  – fine-grained PAT with Contents: Read and write on
#                     Koriebonx98/Games.Database.

name: Seed PC Games Database

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  seed:
    name: Create PC.Games.json if missing
    runs-on: ubuntu-latest

    steps:
      - name: Check for GAMES_DB_TOKEN
        run: |
          if [ -z "${{ secrets.GAMES_DB_TOKEN }}" ]; then
            echo "❌ GAMES_DB_TOKEN secret is not set."
            echo "   Add a fine-grained PAT with Contents: Read and write on"
            echo "   Koriebonx98/Games.Database as the GAMES_DB_TOKEN secret."
            exit 1
          fi
          echo "✅ GAMES_DB_TOKEN is present."

      - name: Seed PC.Games.json
        env:
          GAMES_DB_TOKEN: ${{ secrets.GAMES_DB_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import json, base64, os, sys
          import urllib.request, urllib.error

          token = os.environ['GAMES_DB_TOKEN']
          owner = 'Koriebonx98'
          repo  = 'Games.Database'
          path  = 'PC.Games.json'
          api   = f'https://api.github.com/repos/{owner}/{repo}/contents/{path}'

          headers = {
              'Authorization': f'Bearer {token}',
              'Accept': 'application/vnd.github+json',
              'X-GitHub-Api-Version': '2022-11-28',
              'Content-Type': 'application/json',
          }

          # Check whether the file already exists
          req = urllib.request.Request(api, headers=headers)
          try:
              with urllib.request.urlopen(req) as resp:
                  existing = json.loads(resp.read())
              print(f'ℹ️  PC.Games.json already exists (sha: {existing["sha"][:7]}) — nothing to do.')
              sys.exit(0)
          except urllib.error.HTTPError as e:
              if e.code != 404:
                  print(f'❌ Unexpected HTTP {e.code} checking for PC.Games.json')
                  sys.exit(1)
              # 404 → file does not exist; proceed to create it

          seed_data = {
              "Platform": "PC",
              "Games": [
                  {
                      "Title": "Minecraft",
                      "Description": (
                          "A sandbox game where players explore procedurally generated "
                          "worlds, gather resources, craft tools, and build structures. "
                          "Survive the night or unleash your creativity in Creative mode."
                      ),
                      "stores": [
                          {"name": "Microsoft Store", "url": "https://www.minecraft.net/en-us/store/minecraft-java-bedrock-edition-pc"}
                      ]
                  },
                  {
                      "Title": "Counter-Strike 2",
                      "Description": (
                          "The latest chapter in the iconic tactical shooter franchise. "
                          "CS2 builds on the legacy of Counter-Strike with overhauled "
                          "graphics, responsive smokes, and tick-rate independent gameplay."
                      ),
                      "stores": [
                          {"name": "Steam", "url": "https://store.steampowered.com/app/730/CounterStrike_2/"}
                      ]
                  },
                  {
                      "Title": "Stardew Valley",
                      "Description": (
                          "You've inherited your grandfather's old farm plot in Stardew Valley. "
                          "Armed with hand-me-down tools, you set out to turn the overgrown "
                          "fields into a thriving farm. Explore caves, befriend townsfolk, "
                          "and build the farm of your dreams."
                      ),
                      "stores": [
                          {"name": "Steam", "url": "https://store.steampowered.com/app/413150/Stardew_Valley/"}
                      ]
                  },
                  {
                      "Title": "Terraria",
                      "Description": (
                          "Dig, fight, explore, build! Nothing is impossible in this "
                          "action-packed adventure game. Four decades of content are "
                          "waiting to be discovered."
                      ),
                      "stores": [
                          {"name": "Steam", "url": "https://store.steampowered.com/app/105600/Terraria/"}
                      ]
                  }
              ]
          }

          body = json.dumps({
              'message': 'Seed PC.Games.json with initial PC game entries',
              'content': base64.b64encode(
                  json.dumps(seed_data, indent=2).encode('utf-8')
              ).decode('ascii'),
              'committer': {
                  'name':  'Game.OS Admin',
                  'email': 'admin@gameos.local'
              }
          }).encode('utf-8')

          req = urllib.request.Request(api, data=body, headers=headers, method='PUT')
          try:
              with urllib.request.urlopen(req) as resp:
                  result = json.loads(resp.read())
              sha = result.get('content', {}).get('sha', '')[:7]
              print(f'✅ PC.Games.json created successfully (sha: {sha})')
              print(f'   {len(seed_data["Games"])} games seeded: ' +
                    ', '.join(g["Title"] for g in seed_data["Games"]))
          except urllib.error.HTTPError as e:
              body_text = e.read().decode('utf-8', errors='replace')
              print(f'❌ Failed to create PC.Games.json: HTTP {e.code}')
              print(body_text)
              sys.exit(1)
          PYEOF
