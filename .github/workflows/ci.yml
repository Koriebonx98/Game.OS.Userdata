# CI – runs on every pull request targeting main
#
# Validates:
#   1. The deploy.yml token-injection step would succeed on this branch's script.js
#   2. The frontend HTML files are present and syntactically well-formed
#   3. The backend Node.js code is syntactically valid

name: CI

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify token-injection regex matches script.js
        run: |
          python3 << 'PYEOF'
          import re, sys

          with open('script.js', 'r', encoding='utf-8') as f:
              content = f.read()

          if not re.search(r"const GITHUB_TOKEN\s*=\s*'[^']*';", content):
              print('ERROR: GITHUB_TOKEN placeholder missing or malformed in script.js')
              sys.exit(1)

          print('✅ script.js token placeholder OK')
          PYEOF

      - name: Check frontend files exist
        run: |
          for f in index.html login.html signup.html account.html games.html friends.html inbox.html profile.html script.js styles.css; do
            if [ ! -f "$f" ]; then
              echo "ERROR: missing frontend file: $f"
              exit 1
            fi
          done
          echo "✅ All frontend files present"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check backend JS syntax
        run: node --check backend/index.js && echo "✅ backend/index.js syntax OK"

      - name: Check script.js syntax
        run: node --check script.js && echo "✅ script.js syntax OK"
