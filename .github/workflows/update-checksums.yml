# Update File Checksums
#
# Regenerates security/checksums.sha256 from the files currently on the
# default branch and opens a pull request so the update is reviewed before
# it is merged.
#
# Run this workflow whenever a legitimate code change causes the nightly
# integrity check to fail:
#   Actions → "Update File Checksums" → Run workflow

name: Update File Checksums

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    name: Regenerate checksum manifest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Regenerate checksums
        run: |
          python3 << 'PYEOF'
          import hashlib, os, datetime

          # All files tracked in the manifest
          FILES = [
              'script.js',
              'styles.css',
              'index.html',
              'login.html',
              'signup.html',
              'account.html',
              'games.html',
              'friends.html',
              'inbox.html',
              'profile.html',
              'backend/index.js',
              'backend/package.json',
              'backend/package-lock.json',
              '.github/workflows/ci.yml',
              '.github/workflows/deploy.yml',
              '.github/workflows/security.yml',
              '.github/workflows/update-checksums.yml',
          ]

          def sha256_file(path):
              h = hashlib.sha256()
              with open(path, 'rb') as f:
                  for chunk in iter(lambda: f.read(8192), b''):
                      h.update(chunk)
              return h.hexdigest()

          os.makedirs('security', exist_ok=True)
          ts = datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

          lines = [
              '# Game.OS.Userdata – Critical File Integrity Manifest',
              '#',
              f'# Updated: {ts}',
              '# Generated by: .github/workflows/update-checksums.yml',
              '# Purpose: Detect unauthorised modifications to tracked source files.',
              '#',
              '# Format: <sha256hex>  <relative-path-from-repo-root>',
              '#',
              '# To regenerate after a legitimate change:',
              '#   Actions → "Update File Checksums" → Run workflow',
              '#',
          ]

          for filepath in FILES:
              if os.path.exists(filepath):
                  digest = sha256_file(filepath)
                  lines.append(f'{digest}  {filepath}')
              else:
                  print(f'⚠️  Skipping missing file: {filepath}')

          with open('security/checksums.sha256', 'w') as f:
              f.write('\n'.join(lines) + '\n')

          print('✅ security/checksums.sha256 updated')
          PYEOF

      - name: Create pull request with updated checksums
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'security: regenerate file integrity checksums'
          branch: security/update-checksums
          delete-branch: true
          title: 'security: update file integrity checksums'
          body: |
            ## Checksum Manifest Update

            This PR was generated automatically by the **Update File Checksums** workflow.

            The `security/checksums.sha256` manifest has been regenerated to reflect
            the current state of all tracked source files.

            ### Before merging, please verify:
            - [ ] The file changes listed above are **intentional and expected**
            - [ ] No unexpected files appear in the diff
            - [ ] The nightly security workflow passes after this PR is merged

            > ⚠️ Do **not** merge this PR if you did not trigger the workflow intentionally,
            > as it may conceal unauthorised file modifications.
          labels: security
