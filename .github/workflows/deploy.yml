# Deploy to GitHub Pages with token injection
#
# This workflow:
#   1. Checks out the source code
#   2. Injects DATA_REPO_TOKEN (XOR-hex-encoded) into script.js at build time so the
#      frontend can call the GitHub API directly – no external backend server needed.
#      The token is XOR-hex-encoded to prevent GitHub secret scanning from auto-revoking it.
#   3. Validates that the GitHub data repository is accessible.
#   4. Deploys the frontend to GitHub Pages via the GitHub Actions Pages deployment API
#      (actions/upload-pages-artifact + actions/deploy-pages).
#
# Required setup (one-time):
#   1. Create a private GitHub repository for data (e.g. Game.OS.Private.Data)
#   2. Create a fine-grained Personal Access Token:
#      github.com/settings/tokens → "Fine-grained tokens" → "Generate new token"
#      • Repository access: Only select repositories → your private data repo
#      • Permissions → Repository permissions → Contents: Read and write
#   3. Add the token as a SECRET named DATA_REPO_TOKEN in this repository:
#      Settings → Secrets and variables → Actions → New repository secret
#   4. (Optional) Add a repository VARIABLE named DATA_REPO_NAME with the name of your
#      private data repository (defaults to Game.OS.Private.Data).
#   5. Set GitHub Pages source to "GitHub Actions":
#      Settings → Pages → Source → GitHub Actions
#   6. (Optional) To enable Admin.GameOS cover/trailer editing, create a second
#      fine-grained PAT with Contents: Read and write on the Games.Database repository
#      and add it as a SECRET named GAMES_DB_TOKEN in this repository.
#      To also allow the "Scrape JSON" button to work without a backend, additionally
#      grant Actions: Write on this (Game.OS.Userdata) repository to the same PAT.
#      Without this secret the admin editing panel will show a configuration notice.

name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read    # to checkout the repository
  pages: write      # to deploy to GitHub Pages
  id-token: write   # to verify the deployment originates from an appropriate source

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Inject configuration into script.js
        run: |
          python3 << 'PYEOF'
          import os, json, re, sys

          token      = os.environ.get('DATA_REPO_TOKEN', '')
          owner      = os.environ.get('REPO_OWNER', '')
          data_repo  = os.environ.get('DATA_REPO_NAME', '')

          with open('script.js', 'r', encoding='utf-8') as f:
              content = f.read()

          # ── Inject GITHUB_TOKEN_ENCODED ──────────────────────────────────────
          # The token is XOR-hex-encoded so GitHub secret scanning does not
          # recognise it as a PAT and auto-revoke it. The key 'GameOS_KEY' is
          # not secret; it simply changes the byte representation so the PAT
          # pattern never appears in the committed code.  It is decoded at runtime
          # in script.js by XOR-ing each hex pair back with the same key.
          XOR_KEY = b'GameOS_KEY'
          if token:
              tok_bytes = token.encode('utf-8')
              encoded_token = ''.join(
                  f'{b ^ XOR_KEY[i % len(XOR_KEY)]:02x}'
                  for i, b in enumerate(tok_bytes)
              )
          else:
              encoded_token = ''
          new_token_line = f"const GITHUB_TOKEN_ENCODED = {json.dumps(encoded_token)};"
          updated = re.sub(
              r"const GITHUB_TOKEN_ENCODED\s*=\s*'[^']*';[^\n]*",
              new_token_line,
              content,
              count=1
          )
          if updated == content:
              print('ERROR: GITHUB_TOKEN_ENCODED placeholder not found in script.js — aborting')
              sys.exit(1)
          content = updated

          # ── Inject DATA_REPO_OWNER ───────────────────────────────────────────
          if owner:
              new_owner_line = f"const DATA_REPO_OWNER = {json.dumps(owner)};"
              content = re.sub(
                  r"const DATA_REPO_OWNER\s*=\s*'[^']*';[^\n]*",
                  new_owner_line,
                  content,
                  count=1
              )

          # ── Inject DATA_REPO_NAME ────────────────────────────────────────────
          if data_repo:
              new_repo_line  = f"const DATA_REPO_NAME  = {json.dumps(data_repo)};"
              content = re.sub(
                  r"const DATA_REPO_NAME\s*=\s*'[^']*';[^\n]*",
                  new_repo_line,
                  content,
                  count=1
              )

          # ── Inject GAMES_DB_TOKEN_ENCODED ────────────────────────────────────
          gdb_token = os.environ.get('GAMES_DB_TOKEN', '')
          if gdb_token:
              gdb_bytes = gdb_token.encode('utf-8')
              encoded_gdb = ''.join(
                  f'{b ^ XOR_KEY[i % len(XOR_KEY)]:02x}'
                  for i, b in enumerate(gdb_bytes)
              )
          else:
              encoded_gdb = ''
          new_gdb_line = f"const GAMES_DB_TOKEN_ENCODED = {json.dumps(encoded_gdb)};"
          content = re.sub(
              r"const GAMES_DB_TOKEN_ENCODED\s*=\s*'[^']*';[^\n]*",
              new_gdb_line,
              content,
              count=1
          )

          # ── Inject STEAMGRID_KEY_ENCODED ─────────────────────────────────────
          sgdb_key = os.environ.get('STEAMGRID_API_KEY', '')
          if sgdb_key:
              sgdb_bytes = sgdb_key.encode('utf-8')
              encoded_sgdb = ''.join(
                  f'{b ^ XOR_KEY[i % len(XOR_KEY)]:02x}'
                  for i, b in enumerate(sgdb_bytes)
              )
          else:
              encoded_sgdb = ''
          new_sgdb_line = f"const STEAMGRID_KEY_ENCODED = {json.dumps(encoded_sgdb)};"
          content = re.sub(
              r"const STEAMGRID_KEY_ENCODED\s*=\s*'[^']*';[^\n]*",
              new_sgdb_line,
              content,
              count=1
          )

          with open('script.js', 'w', encoding='utf-8') as f:
              f.write(content)

          # ── Diagnostics ──────────────────────────────────────────────────────
          status = 'injected — GitHub mode (direct API) will be active' if token else 'not set — site will use demo mode'
          print(f'DATA_REPO_TOKEN : {status}')
          if owner:
              print(f'DATA_REPO_OWNER : set to {owner!r}')
          if data_repo:
              print(f'DATA_REPO_NAME  : set to {data_repo!r}')
          if gdb_token:
              print(f'GAMES_DB_TOKEN  : injected — admin game editing enabled')
          else:
              print(f'GAMES_DB_TOKEN  : not set — admin editing will show a configuration notice')
          if sgdb_key:
              print(f'STEAMGRID_API_KEY: injected — in-page SteamGridDB search enabled')
          if not token:
              print('To enable real accounts, add DATA_REPO_TOKEN as a repository secret.')
              print('See README.md for full instructions.')
          PYEOF
        env:
          DATA_REPO_TOKEN: ${{ secrets.DATA_REPO_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          DATA_REPO_NAME: ${{ vars.DATA_REPO_NAME }}
          GAMES_DB_TOKEN: ${{ secrets.GAMES_DB_TOKEN }}
          STEAMGRID_API_KEY: ${{ secrets.STEAMGRID_API_KEY }}

      - name: Validate GitHub data repository access (if token set)
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ vars.DATA_REPO_NAME }}"
          REPO="${REPO:-Game.OS.Private.Data}"
          TOKEN="${{ secrets.DATA_REPO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "ℹ️  DATA_REPO_TOKEN is not set — site will use demo mode."
            echo "   To enable real accounts, add DATA_REPO_TOKEN as a repository secret."
            exit 0
          fi
          echo "Checking access to ${OWNER}/${REPO} …"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}" || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Data repository is accessible (HTTP 200) — GitHub mode will be active"
          elif [ "$HTTP_STATUS" = "401" ]; then
            echo "⚠️  DATA_REPO_TOKEN is invalid or expired (HTTP 401)."
            echo "   Generate a new fine-grained PAT and update the DATA_REPO_TOKEN secret."
          elif [ "$HTTP_STATUS" = "403" ]; then
            echo "⚠️  DATA_REPO_TOKEN lacks permission (HTTP 403)."
            echo "   Ensure the PAT has Contents: Read and write on ${OWNER}/${REPO}."
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "⚠️  Repository ${OWNER}/${REPO} not found (HTTP 404)."
            echo "   Create it at https://github.com/new (set to Private)."
          else
            echo "⚠️  GitHub API returned HTTP ${HTTP_STATUS}. Deployment will continue."
          fi

      - name: Validate Games Database repository access (if GAMES_DB_TOKEN set)
        run: |
          TOKEN="${{ secrets.GAMES_DB_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "ℹ️  GAMES_DB_TOKEN is not set — admin game editing will show a configuration notice."
            exit 0
          fi
          echo "Checking access to Koriebonx98/Games.Database …"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/Koriebonx98/Games.Database" || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Games.Database repository is accessible (HTTP 200) — admin game editing will be active"
          elif [ "$HTTP_STATUS" = "401" ]; then
            echo "❌ GAMES_DB_TOKEN is invalid or expired (HTTP 401)."
            echo "   Generate a new fine-grained PAT with Contents: Read and write on Koriebonx98/Games.Database"
            echo "   and update the GAMES_DB_TOKEN repository secret, then re-run this workflow."
            exit 1
          elif [ "$HTTP_STATUS" = "403" ]; then
            echo "❌ GAMES_DB_TOKEN lacks write permission (HTTP 403)."
            echo "   Ensure the PAT has Contents: Read and write permission scoped to Koriebonx98/Games.Database."
            echo "   Update the GAMES_DB_TOKEN repository secret and re-run this workflow."
            exit 1
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "⚠️  Repository Koriebonx98/Games.Database not found (HTTP 404)."
            echo "   Verify the repository exists and the token has access to it."
          else
            echo "⚠️  GitHub API returned HTTP ${HTTP_STATUS}. Deployment will continue."
          fi

      - name: Copy frontend files to deployment directory
        run: |
          mkdir -p _site
          cp index.html login.html signup.html account.html games.html friends.html inbox.html profile.html script.js styles.css _site/
          touch _site/.nojekyll

      - name: Verify token injection in deployment bundle
        run: |
          python3 << 'PYEOF'
          import re, sys

          with open('_site/script.js', 'r', encoding='utf-8') as f:
              content = f.read()

          match = re.search(r'const GITHUB_TOKEN_ENCODED\s*=\s*"([^"]*)"', content)
          if not match:
              # Also accept single-quoted empty string (no token set)
              empty = re.search(r"const GITHUB_TOKEN_ENCODED\s*=\s*''", content)
              if empty:
                  print('ℹ️  GITHUB_TOKEN_ENCODED is empty – site will use demo mode (DATA_REPO_TOKEN secret not set)')
              else:
                  print('ERROR: GITHUB_TOKEN_ENCODED not found in deployment bundle')
                  sys.exit(1)
          else:
              token_encoded = match.group(1)
              if token_encoded:
                  print(f'✅ GITHUB_TOKEN_ENCODED injected ({len(token_encoded)} hex chars) – live mode will be active')
              else:
                  print('ℹ️  GITHUB_TOKEN_ENCODED is empty – site will use demo mode (DATA_REPO_TOKEN secret not set)')
          PYEOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
