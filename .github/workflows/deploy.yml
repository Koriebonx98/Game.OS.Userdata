# Deploy to GitHub Pages
#
# This workflow:
#   1. Checks out the source code
#   2. Injects the BACKEND_URL repository variable into script.js at build time.
#      BACKEND_URL is NOT a secret – it is a public URL pointing to the backend server.
#      No sensitive tokens are embedded in the deployed files.
#   3. Optionally validates that the configured backend is reachable.
#   4. Deploys the frontend to GitHub Pages via peaceiris/actions-gh-pages
#
# Required setup (one-time):
#   1. Deploy the backend server (see backend/README.md) to Railway, Render, Fly.io, etc.
#      The backend holds DATA_REPO_TOKEN securely as a server environment variable.
#   2. Add a repository VARIABLE named BACKEND_URL with your backend server's URL:
#      Settings → Secrets and variables → Actions → Variables → New repository variable
#      Example: https://my-gameos-backend.railway.app
#   3. Set GitHub Pages source to "Deploy from a branch":
#      Settings → Pages → Source → Deploy from a branch → Branch: gh-pages / (root)

name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write   # peaceiris/actions-gh-pages pushes to the gh-pages branch

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Inject BACKEND_URL into script.js
        run: |
          python3 << 'PYEOF'
          import os, json, re, sys

          backend_url = os.environ.get('BACKEND_URL', '').rstrip('/')

          with open('script.js', 'r', encoding='utf-8') as f:
              content = f.read()

          # ── Inject BACKEND_URL ───────────────────────────────────────────────
          # json.dumps produces a valid JS string literal and handles all special chars.
          # The regex matches any single-quoted value so it works even if the file was
          # previously processed (e.g. re-run without a clean checkout).
          new_url_line = f"const BACKEND_URL = {json.dumps(backend_url)};"
          updated = re.sub(
              r"const BACKEND_URL\s*=\s*'[^']*';[^\n]*",
              new_url_line,
              content,
              count=1
          )
          if updated == content:
              print('ERROR: BACKEND_URL placeholder not found in script.js — aborting')
              sys.exit(1)
          content = updated

          with open('script.js', 'w', encoding='utf-8') as f:
              f.write(content)

          # ── Diagnostics ──────────────────────────────────────────────────────
          if backend_url:
              print(f'BACKEND_URL : set to {backend_url!r} — backend mode will be active')
          else:
              print('BACKEND_URL : not set — site will use demo mode (localStorage only)')
              print('To enable real accounts, add a BACKEND_URL repository variable pointing')
              print('to your deployed backend server (see backend/README.md).')
          PYEOF
        env:
          BACKEND_URL: ${{ vars.BACKEND_URL }}

      - name: Validate backend connectivity (if configured)
        if: vars.BACKEND_URL != ''
        run: |
          BACKEND="${{ vars.BACKEND_URL }}"
          BACKEND="${BACKEND%/}"
          echo "Checking backend health at ${BACKEND}/health …"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "${BACKEND}/health" || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Backend is reachable (HTTP 200)"
          elif [ "$HTTP_STATUS" = "000" ]; then
            echo "⚠️  Backend unreachable (connection failed). Deployment will continue but"
            echo "   the site will fall back to demo mode until the backend is available."
            echo "   Verify that BACKEND_URL is correct and the server is running."
          else
            echo "⚠️  Backend returned HTTP ${HTTP_STATUS}. Deployment will continue."
            echo "   Verify BACKEND_URL and backend health."
          fi

      - name: Copy frontend files to deployment directory
        run: |
          mkdir -p _site
          cp index.html login.html signup.html account.html games.html friends.html inbox.html profile.html script.js styles.css _site/
          touch _site/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          force_orphan: true
