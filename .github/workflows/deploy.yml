# Deploy to GitHub Pages with token injection
#
# This workflow:
#   1. Checks out the source code
#   2. Injects the DATA_REPO_TOKEN secret into script.js at build time
#      (the token is NEVER committed to the repository)
#   3. Deploys the frontend to GitHub Pages
#
# Required setup (one-time):
#   1. Add a secret named DATA_REPO_TOKEN in this repository:
#      Settings → Secrets and variables → Actions → New repository secret
#      Value: your fine-grained PAT (contents: read+write on Game.OS.Private.Data)
#   2. Set GitHub Pages source to "GitHub Actions":
#      Settings → Pages → Source → GitHub Actions

name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject configuration into script.js
        run: |
          python3 << 'PYEOF'
          import os, json, re, sys

          token      = os.environ.get('DATA_REPO_TOKEN', '')
          owner      = os.environ.get('REPO_OWNER', '')
          data_repo  = os.environ.get('DATA_REPO_NAME', '')

          with open('script.js', 'r', encoding='utf-8') as f:
              content = f.read()

          # ── Inject GITHUB_TOKEN ──────────────────────────────────────────────
          # json.dumps produces a valid JS string literal and handles all special chars.
          # The regex matches any single-quoted value so it works even if the file was
          # previously processed (e.g. re-run without a clean checkout).
          new_token_line = f"const GITHUB_TOKEN = {json.dumps(token)};"
          updated = re.sub(
              r"const GITHUB_TOKEN\s*=\s*'[^']*';[^\n]*",
              new_token_line,
              content,
              count=1
          )
          if updated == content:
              print('ERROR: GITHUB_TOKEN placeholder not found in script.js — aborting')
              sys.exit(1)
          content = updated

          # ── Inject DATA_REPO_OWNER ───────────────────────────────────────────
          if owner:
              new_owner_line = f"const DATA_REPO_OWNER = {json.dumps(owner)};"
              content = re.sub(
                  r"const DATA_REPO_OWNER\s*=\s*'[^']*';[^\n]*",
                  new_owner_line,
                  content,
                  count=1
              )

          # ── Inject DATA_REPO_NAME ────────────────────────────────────────────
          if data_repo:
              new_repo_line = f"const DATA_REPO_NAME  = {json.dumps(data_repo)};"
              content = re.sub(
                  r"const DATA_REPO_NAME\s*=\s*'[^']*';[^\n]*",
                  new_repo_line,
                  content,
                  count=1
              )

          with open('script.js', 'w', encoding='utf-8') as f:
              f.write(content)

          # ── Diagnostics ──────────────────────────────────────────────────────
          status = 'injected — GitHub mode will be active' if token else 'not set — site will use demo mode'
          print(f'DATA_REPO_TOKEN : {status}')
          if owner:
              print(f'DATA_REPO_OWNER : set to {owner!r}')
          if data_repo:
              print(f'DATA_REPO_NAME  : set to {data_repo!r}')
          PYEOF
        env:
          DATA_REPO_TOKEN: ${{ secrets.DATA_REPO_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          DATA_REPO_NAME: ${{ vars.DATA_REPO_NAME }}

      - name: Copy frontend files to deployment directory
        run: |
          mkdir -p _site
          cp index.html login.html signup.html account.html games.html profile.html script.js styles.css _site/
          touch _site/.nojekyll

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
